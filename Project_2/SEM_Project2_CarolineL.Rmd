---
title: "SEM Project 2"
author: "Caroline Lee"
date: "`r Sys.Date()`"
output: html_notebook
---

```{r setup, include = FALSE, results='hide'}
# detach all libraries

detachAllPackages <- function() {
  basic.packages <- c("package:stats", "package:graphics", "package:grDevices", "package:utils", "package:datasets", "package:methods", "package:base")
  package.list <- search()[ifelse(unlist(gregexpr("package:", search()))==1, TRUE, FALSE)]
  package.list <- setdiff(package.list, basic.packages)
  if (length(package.list)>0)  for (package in package.list) detach(package,  character.only=TRUE)
}
detachAllPackages()

# function to load libraries

pkgTest <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[,  "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg,  dependencies = TRUE)
  sapply(pkg,  require,  character.only = TRUE)
}

# loading packages 

lapply(c("DT"),pkgTest)
lapply(c("haven"),pkgTest)
lapply(c("lavaan"),pkgTest)
lapply(c("MplusAutomation"),pkgTest)
lapply(c("readxl"),pkgTest)
lapply(c("sjlabelled"),pkgTest)
lapply(c("sjmisc"),pkgTest)
lapply(c("texreg"),pkgTest)
lapply(c("tidyverse"),pkgTest)

library(DT)
library(haven)
library(lavaan)
library(MplusAutomation)
library(readxl)
library(sjlabelled)
library(sjmisc)
library(texreg)
library(tidyverse)

knitr::opts_chunk$set(fig.height=5, fig.width=7)
```

## Part I
Suppose a researcher was interested in investigating the determinants of coping styles for college students. To evaluate this researcher's path model, Let's assume six variables were collected from 200 college students as follows:

- v1: stress  
- v2: efficacy  
- v3: resilience  
- v4: problem-solving coping  
- v5: social-support coping  
- v6: avoidance coping  

```{r, echo = FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/carolinelee78/SEM-S2024/main/Project_2/PathDiagram1_Project2.png")
```
 
The file `coping.csv` contains the data for these six variables. The following path diagram presents the theory of the hypothetical:

1. Let's do initial model evaluations.
    - (1-a) **How many endogenous variables in this model?**
      * There are 5 endogenous variables in this model: stress (v1), resilience (v3), problem solving (v4), social support (v5), and avoidance (v6).
    - (1-b) **How many parameters does this model have? Count each kind of parameters. Be sure to include the variance(s) of exogenous variable(s) and covariance(s) between exogenous variable(s), if any.** 
    - (1-c) **What is the number of unique elements of the data covariance matrix?**
       * Number of unique elements in the data covariance matrix = $\frac{q(q+1)}{2} = \frac{6(6+1)}{2} = 21$ 
    - (1-d) **What is the degrees of freedom (_df_) for this model? Show how you derived the _df_.**
        * Number of model parameters = 15
           - 9 regression paths 
           - 5 residual variances 
           - 1 variance for exogenous variable v2
        * _df_ = 21 - 15 = 6
    - (1-e) List all possible indirect (mediation) effects of efficacy `v2` on avoidance coping `v4` in this model. Use a format of A→B→C, where the effect of variable A to variable C is mediated by variable B.
  
2. Estimate this model using the bootstrap method with 10000 bootstrap iterations with Mplus via `MplusAutomation`. Request the indirect effects of efficacy `v2` on avoidance coping `v6`. Also, request standardized results, as well as bootstrap confidence intervals.  
    * (2-a)  Present the R code for (a) setting up the model by a combination of `sink()` and `cat()` functions, (b) running the model by the `runModels()` function, and (c) reading the output file by the `readModels()` function and save as an object called `model01.fit`.
    
- Note: 
      * By default, it appears that Mplus will include error covariances between endogenous variables with no direct path in-between. Therefore, you need to constrain these error terms to be 0. Specifically, you need to constrain that the error covariances between `v4` and `v5`, between `v4` and `v6`, and between `v5` and `v6` to be 0. 
            - For example, to constrain the error covariance between `v4` and `v5` to 0, add a Mplus syntax line: `v4 with v5@0;`

3. Let's look at the fit indices.
    * (3-a) Run a line of code `model01.fit$summaries %>% unlist()`. Note that `model01.fit` is the object you created in the Step (e) of Question (2-a).
    * (3-b) Briefly comment on Chi-square-related values ($\chi^2$, $df$, and $p$-value), CFI, TLI, RMSEA, 90% CI of RMSEA, and SRMR. 
    * (3-c) Hand compute RMSEA for the baseline model by hand. Based on Kenny's recommendation, Would you support the use of CFI and TLI? Why? Why not?
    * (3-d) Would you be satisfied with the fit of this model? Why? Why not? What would you do next, if you are not satisfied?

- (4) Let's look at the estimated model parameters.
    * (4-a) Extract estimated standardized model parameters (i.e., path coefficients, intercepts, and residual variances). Use `model01.fit$parameters$stdyx.standardized`, assuming the output object has been saved as `model01.fit`.
    * (4-b) Interpret the standardized path coefficients of stress on avoidance coping.

- (5) Let's look at the results of total indirect effects.
    * (5-a) Extract the standardized results of indirect effect analyses.  
        + Assuming the output object has been saved as `model01.fit`, run `model01.fit$indirect$stdyx.standardized`.   
    * (5-c)	Briefly comment the interpretations of the direct, indirect, and total effects of efficacy on avoidance coping.

## Part II
This part of the Project asks you to replicate the `ex2.29` on slides 36-37 in `03_Mediation Analysis.pdf`.  

Note that this is the "Case 3" in the course slide set, where the mediation effect and the direct effect would be moderated by the exposure variable $x$.

0. Load all functions in the `mplus.R` file by using the `source()` function.

1. Replicate the analysis with Mplus by using `MplusAutomation` package. Provide the R code for (a) generating external syntax file for Mplus by the combination of `sink()` and `cat()` functions, and (b) running the model by the `runModels()` function.

2. Draw the same two plots on slides 37 by using `mplus.plot.loop()` function available in `mplus.R`. Provide the R code and plot for each of (a) indirect effects and (b) total effects.

3. Extract results or R for each of the evaluation points by using functions available in `mplus.R` (`mplus.get.loop.xvalues`, `mplus.get.loop.estimates`, `mplus.get.loop.lowerci`, and `mplus.get.loop.upperci`). Provide the R code and output table for each of (a) indirect effects and (b) total effects.

## Part III
By using the coping data in Part I, examine the mediation effect of efficacy `v2` -> resilience `v3` -> problem solving `v4`, whether it is moderated by stress `v1` if `v1` interacts with resilience `v3`. In other words, test the moderated mediation effect depicted in the following diagram.  

Note that this analysis falls into the "Case 2" in the course slide set, where both mediation effect and direct effect would be moderated by the covariate (v1 in this case).  

Conduct the analysis with Mplus by using `MplusAutomation` package. Specifications should include:  

- Use the `MOD` keyword under the `model indirect:` command line in the Mplus syntax.  
- Compute the mediation effects for the range of (7, 50) with an increment of 0.1 for the moderator stress `v1`.
- Evaluate the mediation effects for an increment of 1 SD increase in the exposure variable efficacy `v2`. In other words, use $(x_1, x_0)=(37.48, 30.06)$. 
- Use `bootstrap = 5000`. 
- Request `PLOT: type = plot3;` to produce a graphical data file.  

1. Provide the R code for (a) generating external syntax file for Mplus by the combination of `sink()` and `cat()` functions, and (b) running the model by the `runModels()` function.

2. Draw a plot to show the estimated moderated mediation effect and the 95% CI band using `mplus.plot.moderation()` function available in `mplus.R`. Provide the R code and plot. Comment (a) how the mediation effect changes based on the value of the moderator, and (b) approximately what range of the moderator values is associated with statistically significant mediation effect.

3. Extract estimated mediation effect and 95% CI for each of the evaluation points by using functions available in `mplus.R` (`mplus.get.moderation.xvalues`, `mplus.get.moderation.estimates`, `mplus.get.moderation.lowerci`, and `mplus.get.moderation.upperci`). Provide the R code and output table. Comment (a) what range of the moderator values is associated with statistically significant mediation effect.




